<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Records - SSH Log Tools</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <header>
      <h1>SSH Log Tools</h1>
      <nav>
        <a href="/">Logs</a>
        <a href="/profiles">Profiles</a>
        <a href="/records">Records</a>
        <a href="/tags">Tags</a>
        <a href="/docs" target="_blank">API Docs</a>
      </nav>
      <div class="actions"></div>
    </header>
    <main>
      <aside>
        <div class="panel">
          <h2>Profile</h2>
          <select id="profileSelect"></select>
        </div>
      </aside>
      <section class="viewer">
        <div class="panel" style="margin:10px">
          <div class="filter-bar">
            <label>Tag
              <select id="filterTag"></select>
            </label>
            <label>Start
              <input type="date" id="filterStart" />
            </label>
            <label>End
              <input type="date" id="filterEnd" />
            </label>
            <button id="filterBtn" type="button">Filter</button>
            <button id="exportBtn" type="button">Export</button>
          </div>
          <table id="tbl">
            <thead><tr>
              <th data-sort="id">ID</th>
              <th data-sort="profile">Profile</th>
              <th data-sort="file_path">Path</th>
              <th>Logs</th>
              <th data-sort="title">Title</th>
              <th data-sort="situation">Situation</th>
              <th data-sort="description">Description</th>
              <th>Tags</th>
              <th>Image link</th>
              <th data-sort="event_time">Situation Date</th>
              <th data-sort="created_at">Create Date</th>
              <th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    <!-- Fullscreen Image Viewer -->
    <div id="imgViewer" class="img-viewer">
      <div class="inner">
        <button class="close" id="imgViewClose">Close</button>
        <button class="nav prev" id="imgViewPrev">❮</button>
        <img id="imgViewImg" src="" alt="preview" />
        <button class="nav next" id="imgViewNext">❯</button>
      </div>
    </div>
    {% include '_record_form.html' %}
    <script src="/static/record_form.js"></script>
<script>
  window.APP_CFG = {{ (app_cfg or {'apiTimeoutMs':30000}) | tojson }};
  // mark active nav
  (function(){
    var path = location.pathname.replace(/\/+$/, '') || '/';
    document.querySelectorAll('header nav a').forEach(function(a){
      var href = a.getAttribute('href');
      if(href === path) a.classList.add('active');
    });
  })();
  // simple prefs
  const PREF_NS='sshlt_';
  function setPref(k,v){ try{ localStorage.setItem(PREF_NS+k, JSON.stringify(v)); }catch{} }
  function getPref(k,d){ try{ const v=localStorage.getItem(PREF_NS+k); return v? JSON.parse(v): d; }catch{ return d; } }
  let PROFILES=[]; TAG_CACHE=[];
  let PROFILE_ID=getPref('records.PROFILE_ID','all');
  let TAG_FILTER='all', START_DATE='', END_DATE='';
  let SORT_KEY='id', SORT_DIR=-1;
  let RECORDS=[];
  async function loadProfiles(){
    const d = await (await fetch('/api/profiles')).json();
    PROFILES = d.profiles||[];
    const sel = document.getElementById('profileSelect'); sel.innerHTML='';
    sel.add(new Option('All profiles','all'));
    PROFILES.forEach(p=> sel.add(new Option(p.name, p.id)));
    sel.value = PROFILE_ID;
  }
  async function loadTags(){
    const d = await (await fetch('/api/tags')).json();
    TAG_CACHE = d.tags||[];
    const sel = document.getElementById('filterTag'); sel.innerHTML='';
    sel.add(new Option('All','all'));
    TAG_CACHE.forEach(t=> sel.add(new Option(t.name, t.id)));
    sel.value = TAG_FILTER;
  }
  async function loadRecords(){
    const params = new URLSearchParams();
    if(TAG_FILTER!=='all') params.append('tag', TAG_FILTER);
    if(START_DATE) params.append('start', START_DATE);
    if(END_DATE) params.append('end', END_DATE);
    const r = await fetch('/api/records?'+params.toString());
    const data = await r.json();
    RECORDS = (data.records||[]).filter(rec => PROFILE_ID==='all' || rec.profile_id===Number(PROFILE_ID));
    renderTable();
  }
  function renderTable(){
    const pm = {}; PROFILES.forEach(p=>pm[p.id]=p.name);
    const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
    const arr = [...RECORDS];
    arr.sort((a,b)=>{
      let va, vb;
      if(SORT_KEY==='profile'){ va=pm[a.profile_id]||''; vb=pm[b.profile_id]||''; }
      else { va=a[SORT_KEY]; vb=b[SORT_KEY]; }
      if(va==null) va=''; if(vb==null) vb='';
      if(typeof va==='string') va=va.toLowerCase();
      if(typeof vb==='string') vb=vb.toLowerCase();
      if(va<vb) return -SORT_DIR; if(va>vb) return SORT_DIR; return 0;
    });
    arr.forEach(rec=>{
      const tr = document.createElement('tr');
      const imgs = (rec.images||[]).map(i=>`<a href=\"${i.url||i.path}\" target=\"_blank\">img#${i.id}</a>`).join(', ');
      const created = new Date((rec.created_at||0)*1000).toLocaleString();
      const situationDate = rec.event_time ? new Date(rec.event_time*1000).toLocaleString() : '';
      const logs = (rec.content||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const situation = rec.situation||'';
      const desc = (rec.description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const tags = (rec.tags||[]).map(t=>`<button class=\"tag-btn\" type=\"button\">${t.name}</button>`).join(' ');
      tr.innerHTML = `<td>${rec.id}</td><td>${pm[rec.profile_id]||''}</td><td>${rec.file_path||''}</td><td>${logs}</td><td>${rec.title||''}</td><td>${situation}</td><td>${desc}</td><td>${tags}</td><td>${imgs}</td><td>${situationDate}</td><td>${created}</td><td><button data-act=\"del\" data-id=\"${rec.id}\" style=\"border-color:#991b1b\">Delete</button></td>`;
      tr.addEventListener('click', (ev)=>{ if(ev.target.closest('button')) return; openDetail(rec); });
      tb.appendChild(tr);
    });
    document.querySelectorAll('#tbl thead th').forEach(th=>{
      const key = th.dataset.sort; if(!key) return;
      let base = th.textContent.replace(/[▲▼]\s*$/,'');
      if(key===SORT_KEY) base += SORT_DIR===1?' ▲':' ▼';
      th.textContent = base;
    });
  }
  document.getElementById('tbl').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(btn.dataset.act==='del'){
      if(!confirm('Delete this record?')) return;
      const rid = btn.dataset.id; const r = await fetch(`/api/records/${rid}`, { method:'DELETE' });
      if(r.ok){ loadRecords(); } else { alert('Delete failed'); }
    }
  });
  function openDetail(rec){
    openRecordForm({
      id: rec.id,
      profile_id: rec.profile_id,
      file_path: rec.file_path || '',
      title: rec.title || '',
      situation: rec.situation || '',
      description: rec.description || '',
      content: rec.content || '',
      event_time: rec.event_time || null,
      images: rec.images || [],
      tags: rec.tags || []
    });
  }
  document.addEventListener('recordFormSaved', loadRecords);
  document.getElementById('profileSelect').addEventListener('change', (e)=>{ PROFILE_ID = e.target.value; setPref('records.PROFILE_ID', PROFILE_ID); loadRecords(); });
  document.getElementById('filterBtn').addEventListener('click', ()=>{
    TAG_FILTER = document.getElementById('filterTag').value;
    START_DATE = document.getElementById('filterStart').value;
    END_DATE = document.getElementById('filterEnd').value;
    loadRecords();
  });
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const params = new URLSearchParams();
    if(TAG_FILTER!=='all') params.append('tag', TAG_FILTER);
    if(START_DATE) params.append('start', START_DATE);
    if(END_DATE) params.append('end', END_DATE);
    window.location = '/api/records/export?'+params.toString();
  });
  document.querySelectorAll('#tbl thead th[data-sort]').forEach(th=>{
    const key = th.dataset.sort;
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
      if(SORT_KEY===key){ SORT_DIR*=-1; } else { SORT_KEY=key; SORT_DIR=1; }
      renderTable();
    });
  });
  (async ()=>{ await loadProfiles(); await loadTags(); await loadRecords(); })();
  // viewer fn (shared with Logs page)
  let IMG_VIEW = { arr: [], idx: 0 };
  function openImageViewer(arr, start){
    try{ IMG_VIEW.arr = arr||[]; IMG_VIEW.idx = Math.max(0, Math.min(start||0, IMG_VIEW.arr.length-1)); }catch{ IMG_VIEW={arr:[], idx:0}; }
    const wrap = document.getElementById('imgViewer'); const img = document.getElementById('imgViewImg');
    if(!wrap||!img) return;
    const render = ()=>{ img.src = IMG_VIEW.arr[IMG_VIEW.idx]||''; };
    render();
    wrap.style.display='flex';
    const prev = document.getElementById('imgViewPrev'); const next = document.getElementById('imgViewNext'); const close =document.getElementById('imgViewClose');
    if(prev) prev.onclick = (e)=>{ e.stopPropagation(); if(IMG_VIEW.idx>0){ IMG_VIEW.idx--; render(); } };
    if(next) next.onclick = (e)=>{ e.stopPropagation(); if(IMG_VIEW.idx<IMG_VIEW.arr.length-1){ IMG_VIEW.idx++; render(); } };
    if(close) close.onclick = ()=>{ wrap.style.display='none'; };
    wrap.onclick = ()=>{ wrap.style.display='none'; };
    function esc(e){ if(e.key==='Escape'){ wrap.style.display='none'; document.removeEventListener('keydown', esc);} if(e.key==='ArrowLeft'){ if(IMG_VIEW.idx>0){ IMG_VIEW.idx--; render(); } } if(e.key==='ArrowRight'){ if(IMG_VIEW.idx<IMG_VIEW.arr.length-1){ IMG_VIEW.idx++; render(); } } }
    document.addEventListener('keydown', esc);
  }
</script>
</body>
  </html>
