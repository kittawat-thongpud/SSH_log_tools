<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Records - SSH Log Tools</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <header>
      <h1>SSH Log Tools</h1>
      <nav>
        <a href="/">Logs</a>
        <a href="/profiles">Profiles</a>
        <a href="/records">Records</a>
        <a href="/docs" target="_blank">API Docs</a>
      </nav>
      <div class="actions"></div>
    </header>
    <main>
      <aside>
        <div class="panel">
          <h2>Profile</h2>
          <select id="profileSelect"></select>
        </div>
      </aside>
      <section class="viewer">
        <div class="panel" style="margin:10px">
          <table id="tbl">
            <thead><tr>
              <th>ID</th>
              <th>Profile</th>
              <th>Path</th>
              <th>Logs</th>
              <th>Title</th>
              <th>Situation</th>
              <th>Description</th>
              <th>Image link</th>
              <th>Situation Date</th>
              <th>Create Date</th>
              <th></th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    <!-- Fullscreen Image Viewer -->
    <div id="imgViewer" class="img-viewer">
      <div class="inner">
        <button class="close" id="imgViewClose">Close</button>
        <button class="nav prev" id="imgViewPrev">❮</button>
        <img id="imgViewImg" src="" alt="preview" />
        <button class="nav next" id="imgViewNext">❯</button>
      </div>
    </div>
    {% from 'components/record_form.html' import record_form %}
    <!-- Record Detail Modal -->
    <div id="recordModal" class="modal">
      <div class="content">
        <h3>Record Detail</h3>
        {% call record_form() %}
          <div>
            <strong>Images</strong>
            <div id="recordImgs" style="display:grid; grid-template-columns: repeat(auto-fill, 120px); gap:8px; margin:8px 0;"></div>
            <div>
              <input type="file" id="recordAddImg" multiple accept="image/*" />
              <button type="button" id="recordAddImgBtn">Add Images</button>
            </div>
          </div>
        {% endcall %}
      </div>
    </div>
    <script>
      window.APP_CFG = {{ (app_cfg or {'apiTimeoutMs':30000}) | tojson }};
      // mark active nav
      (function(){
        var path = location.pathname.replace(/\/+$/, '') || '/';
        document.querySelectorAll('header nav a').forEach(function(a){
          var href = a.getAttribute('href');
          if(href === path) a.classList.add('active');
        });
      })();
      // simple prefs
      const PREF_NS='sshlt_';
      function setPref(k,v){ try{ localStorage.setItem(PREF_NS+k, JSON.stringify(v)); }catch{} }
      function getPref(k,d){ try{ const v=localStorage.getItem(PREF_NS+k); return v? JSON.parse(v): d; }catch{ return d; } }
      let PROFILES=[];
      let PROFILE_ID=getPref('records.PROFILE_ID','all');
      async function loadProfiles(){
        const d = await (await fetch('/api/profiles')).json();
        PROFILES = d.profiles||[];
        const sel = document.getElementById('profileSelect'); sel.innerHTML='';
        sel.add(new Option('All profiles','all'));
        PROFILES.forEach(p=> sel.add(new Option(p.name, p.id)));
        sel.value = PROFILE_ID;
      }
      async function load(){
        const r = await fetch('/api/records'); const data = await r.json();
        const pm = {}; PROFILES.forEach(p=>pm[p.id]=p.name);
        const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
        (data.records||[])
          .filter(rec => PROFILE_ID==='all' || rec.profile_id===Number(PROFILE_ID))
          .forEach(rec=>{
            const tr = document.createElement('tr');
            const imgs = (rec.images||[]).map(i=>`<a href=\"${i.url||i.path}\" target=\"_blank\">img#${i.id}</a>`).join(', ');
            const created = new Date((rec.created_at||0)*1000).toLocaleString();
            const situationDate = rec.event_time ? new Date(rec.event_time*1000).toLocaleString() : '';
            const logs = (rec.content||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const situation = rec.situation||'';
            const desc = (rec.description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            tr.innerHTML = `<td>${rec.id}</td><td>${pm[rec.profile_id]||''}</td><td>${rec.file_path||''}</td><td>${logs}</td><td>${rec.title||''}</td><td>${situation}</td><td>${desc}</td><td>${imgs}</td><td>${situationDate}</td><td>${created}</td><td><button data-act=\"del\" data-id=\"${rec.id}\" style=\"border-color:#991b1b\">Delete</button></td>`;
            tr.addEventListener('click', (ev)=>{ if(ev.target.closest('button')) return; openDetail(rec); });
            tb.appendChild(tr);
          });
      }
      document.getElementById('tbl').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.act==='del'){
          if(!confirm('Delete this record?')) return;
          const rid = btn.dataset.id; const r = await fetch(`/api/records/${rid}`, { method:'DELETE' });
          if(r.ok){ load(); } else { alert('Delete failed'); }
        }
      });
      function openDetail(rec){
        const modal = document.getElementById('recordModal');
        const form = document.getElementById('recordForm');
        form.elements['id'].value = rec.id;
        if(form.elements['file_path']) form.elements['file_path'].value = rec.file_path||'';
        if(form.elements['content']) form.elements['content'].value = rec.content||'';
        form.elements['title'].value = rec.title||'';
        form.elements['situation'].value = rec.situation||'';
        form.elements['description'].value = rec.description||'';
        if(rec.event_time){ const dt = new Date(rec.event_time*1000); form.elements['event_dt'].value = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString().slice(0,16); } else { form.elements['event_dt'].value=''; }
        const grid = document.getElementById('recordImgs'); grid.innerHTML='';
        (rec.images||[]).forEach(img=>{
          const wrap = document.createElement('div'); wrap.className='thumb';
          wrap.innerHTML = `<img src="${img.url||img.path}" loading="lazy"><div class="meta"><span class="idx">#${img.id}</span><button type="button" data-act="imgview" data-src="${img.url||img.path}">View</button><button type="button" data-act="imgdel" data-id="${img.id}" style="border-color:#991b1b">Remove</button></div>`;
          grid.appendChild(wrap);
        });
        modal.style.display='flex';
      }
      document.getElementById('recordCancel').addEventListener('click', ()=>{ document.getElementById('recordModal').style.display='none'; });
      document.getElementById('recordForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.target;
        const payload = {
          title: f.elements['title'].value,
          situation: f.elements['situation'].value,
          description: f.elements['description'].value,
          event_time: (function(){ const v=f.elements['event_dt'].value; if(!v) return null; const t=Date.parse(v); return isNaN(t)? null : Math.floor(t/1000); })(),
        };
        const rid = f.elements['id'].value;
        const r = await fetch(`/api/records/${rid}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(r.ok){ alert('Saved'); document.getElementById('recordModal').style.display='none'; load(); } else { alert('Save failed'); }
      });
      document.getElementById('recordImgs').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(btn.dataset.act==='imgview'){
          const grid = document.getElementById('recordImgs');
          const urls = [...grid.querySelectorAll('img')].map(im=> im.getAttribute('src'));
          const src = btn.dataset.src; const idx = urls.indexOf(src);
          openImageViewer(urls, idx>=0?idx:0);
          return;
        }
        if(btn.dataset.act==='imgdel'){
          const iid = btn.dataset.id; const r = await fetch(`/api/record_images/${iid}`, { method:'DELETE' });
          if(r.ok){ load(); document.getElementById('recordModal').style.display='none'; }
        }
      });
      document.getElementById('recordAddImgBtn').addEventListener('click', async ()=>{
        const input = document.getElementById('recordAddImg'); const rid = document.getElementById('recordForm').elements['id'].value;
        const files = input.files||[]; if(!files.length) return;
        for(const f of files){ const fd = new FormData(); fd.append('file', f); await fetch(`/api/records/${rid}/image`, { method:'POST', body: fd }); }
        alert('Images added'); document.getElementById('recordModal').style.display='none'; load();
      });
      document.getElementById('profileSelect').addEventListener('change', (e)=>{ PROFILE_ID = e.target.value; setPref('records.PROFILE_ID', PROFILE_ID); load(); });
      (async ()=>{ await loadProfiles(); await load(); })();
      // viewer fn (shared with Logs page)
      let IMG_VIEW = { arr: [], idx: 0 };
      function openImageViewer(arr, start){
        try{ IMG_VIEW.arr = arr||[]; IMG_VIEW.idx = Math.max(0, Math.min(start||0, IMG_VIEW.arr.length-1)); }catch{ IMG_VIEW={arr:[], idx:0}; }
        const wrap = document.getElementById('imgViewer'); const img = document.getElementById('imgViewImg');
        if(!wrap||!img) return;
        const render = ()=>{ img.src = IMG_VIEW.arr[IMG_VIEW.idx]||''; };
        render();
        wrap.style.display='flex';
        const prev = document.getElementById('imgViewPrev'); const next = document.getElementById('imgViewNext'); const close = document.getElementById('imgViewClose');
        if(prev) prev.onclick = (e)=>{ e.stopPropagation(); if(IMG_VIEW.idx>0){ IMG_VIEW.idx--; render(); } };
        if(next) next.onclick = (e)=>{ e.stopPropagation(); if(IMG_VIEW.idx<IMG_VIEW.arr.length-1){ IMG_VIEW.idx++; render(); } };
        if(close) close.onclick = ()=>{ wrap.style.display='none'; };
        wrap.onclick = ()=>{ wrap.style.display='none'; };
        function esc(e){ if(e.key==='Escape'){ wrap.style.display='none'; document.removeEventListener('keydown', esc);} if(e.key==='ArrowLeft'){ if(IMG_VIEW.idx>0){ IMG_VIEW.idx--; render(); } } if(e.key==='ArrowRight'){ if(IMG_VIEW.idx<IMG_VIEW.arr.length-1){ IMG_VIEW.idx++; render(); } } }
        document.addEventListener('keydown', esc);
      }
    </script>
  </body>
  </html>
